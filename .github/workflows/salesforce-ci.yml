name: Salesforce CI/CD Practice

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  salesforce-ci:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Install Salesforce CLI
        run: npm install -g sfdx-cli

      - name: Authenticate with Salesforce
        run: echo ${{ secrets.SF_AUTH_URL }} | sfdx auth:sfdxurl:store --setalias ci-scratch-org

      - name: Create Scratch Org
        run: sfdx force:org:create -f config/project-scratch-def.json -a ci-scratch-org -s -d 1

      - name: Push Source to Scratch Org
        run: sfdx force:source:push -u ci-scratch-org

      - name: Run Apex Tests
        run: sfdx force:apex:test:run -u ci-scratch-org --resultformat tap --codecoverage

      - name: Delete Scratch Org
        if: always()
        run: sfdx force:org:delete -u ci-scratch-org --noprompt

