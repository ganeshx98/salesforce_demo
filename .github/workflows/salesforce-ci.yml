name: Jira Integration Test

on:
  push:
    branches:
      - main

jobs:
  jira-comment:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Extract Jira Issue Key from Commit Message
        id: extract_jira
        run: |
          ISSUE_KEY=$(git log -1 --pretty=%B | grep -oE '[A-Z]+-[0-9]+' || echo "NoIssue")
          echo "JIRA_ISSUE_KEY=$ISSUE_KEY" >> $GITHUB_ENV

      - name: Comment on Jira Issue
        if: env.JIRA_ISSUE_KEY != 'NoIssue'
        run: |
          curl --request POST \
          --url "${{ secrets.JIRA_URL }}/rest/api/3/issue/${{ env.JIRA_ISSUE_KEY }}/comment" \
          --header "Authorization: Basic $(echo -n ${{ secrets.JIRA_EMAIL }}:${{ secrets.JIRA_API_TOKEN }} | base64)" \
          --header "Accept: application/json" \
          --header "Content-Type: application/json" \
          --data '{
            "body": {
              "type": "doc",
              "version": 1,
              "content": [
                {
                  "type": "paragraph",
                  "content": [
                    {
                      "type": "text",
                      "text": "This issue is referenced in a new commit: https://github.com/${{ github.repository }}/commit/${{ github.sha }}"
                    }
                  ]
                }
              ]
            }
          }'
